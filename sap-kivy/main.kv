#:kivy 1.9.1

<MainScreen>:
    id: main_screen
    reset_flow_popup: reset_flow_popup.__self__

    LabelStatus:
        size_hint: None, None
        height: main_tabbed_panel.tab_height
        width: 125
        pos: main_tabbed_panel.width - self.width - 2, main_tabbed_panel.height - self.height - 2
        font_size: '17sp'
        bstate: app.arduino.system_status

    TabbedPanel:
        id: main_tabbed_panel
        size_hint: 1, 1
        do_default_tab: False
        on_children: main_tabbed_panel.switch_to(main)

        TabbedPanelItem:
            text: 'Main'
            id: main

            BoxLayout:
                orientation: 'vertical'
                padding: 5
                spacing: 0

                GridLayout:
                    id: flow_layout
                    rows: 1
                    cols: 3
                    size_hint: 1, 0.6
                    padding: 0, 0, 0, 0
                    spacing: 10

                    FlowCluster:
                        label: 'Water'
                        flow: app.arduino.water_flow
                        gallons: app.arduino.water_gallons

                    FlowCluster:
                        label: 'Sap'
                        flow: app.arduino.sap_flow
                        gallons: app.arduino.sap_gallons

                    FlowCluster:
                        label: 'Total'
                        flow: app.arduino.total_flow
                        gallons: app.arduino.total_gallons

                Label:
                    text: '[size=30]Efficiency: [/size]' + app.arduino.efficiency + '[size=25] %[/size]'
                    font_size: '45sp'
                    markup: 'True'
                    size_hint: 1, .2

                GridLayout:
                    id: main_buttons_layout
                    rows: 1
                    cols: 6
                    size_hint: 1, .2
                    padding: 0, 10, 0, 0

                    MainButton:
                        text: 'Enable'
                        on_release: app.arduino.set('digital_output/enable/1')

                    MainButton:
                        text: 'Run Auto'
                        on_release: app.arduino.set('run_auto/1')

                    MainButton:
                        text: 'Stop'
                        on_release: app.arduino.set('run_auto/0')

                    MainButton:
                        text: 'Reset'
                        on_release: reset_flow_popup.open()

                    Popup:
                        id: reset_flow_popup
                        title: "Reset Flow Data"
                        size_hint: None, None
                        size: 300, 300
                        on_parent:
                            if self.parent == main_buttons_layout: self.parent.remove_widget(self)

                        BoxLayout:
                            orientation: 'vertical'

                            Label:
                                text: 'Are you sure you want to reset flow data?'
                                size_hint: 1, .8
                                text_size: self.width, None
                                height: self.texture_size[1]
                                font_size: '18sp'
                                halign: 'center'

                            GridLayout:
                                rows: 1
                                cols: 2
                                size_hint: 1, .2

                                Button:
                                    text: 'Yes'
                                    on_release: app.arduino.set('flow_config/reset_sap/0'); app.arduino.set('flow_config/reset_water/0')

                                Button:
                                    text: 'Cancel'
                                    on_release: reset_flow_popup.dismiss()

        TabbedPanelItem:
            text: 'Manual'
            id: manuel

            GridLayout:
                rows: 1
                cols: 3
                spacing: 30

                GridLayout:
                    id: manual_layout
                    rows: 4
                    cols: 1
                    padding: 60, 60, 12, 0
                    spacing: 25

                    Button:
                        text: 'Test'

                    Button:
                        text: 'Test'

        TabbedPanelItem:
            text: 'Settings'
            id: settings_tab

            RelativeLayout:
                id: settings_layout

                BoxLayout:
                    id: settings_box_layout
                    orientation: 'horizontal'
                    padding: 10
                    spacing: 5

                    BoxLayout:
                        id: backlight_layout
                        orientation: 'vertical'
                        size_hint_x: 0.2
                        padding: 10
                        spacing: 5

                        Label:
                            text: 'Screen\nBrightness'
                            markup: True
                            size_hint_y: 0.1
                            text_size: self.size
                            halign: 'center'
                            valign: 'middle'

                        Slider:
                            id: screen_brightness_slider
                            on_touch_move: root.sm.brightness()
                            on_touch_up: root.sm.save_settings()
                            orientation: 'vertical'
                            min: 20
                            max: 200
                            value: 200
                            size_hint_y: 0.9

                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_x: 0.2
                        padding: 10
                        spacing: 15

                        Button:
                            id: modify_screen
                            text: 'Modify\n Main Screen'
                            halign: 'center'
                            valign: 'middle'
                            size_hint_y: 0.15
                            on_press: if not dynamic_layout.modify_mode: enter_modify_popup.open(); app.arduino.toggle_ser_read(False)

                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: 0.17
                            padding: 5, 0, 0, 0

                            Label:
                                text: 'Screen Off Delay:'

                            BoxLayout:
                                orientation: 'horizontal'

                                TextInput:
                                    id: screen_off_delay_input
                                    on_text: root.sm.save_settings()
                                    text: '30'
                                    size_hint_x: 0.4

                                Label:
                                    text: 'seconds'
                                    size_hint_x: 0.6

                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: 0.17
                            padding: 5, 0, 0, 0

                            Label:
                                text: 'Password Disable:'

                            Switch:
                                id: password_disable_switch
                                on_active: root.sm.save_settings()

                        BoxLayout:
                            orientation: 'vertical'
                            size_hint_y: 0.53

                    BoxLayout:
                        orientation: 'vertical'
                        size_hint_x: 0.6
                        padding: 10
                        spacing: 5

                Button:
                    id: exit_button
                    on_press: app.exit_app()
                    text: 'X'
                    size_hint: None, None
                    size: 20, 20
                    right: root.right

        Popup:
            id: enter_modify_popup
            title: "Modify Main Screen"
            size_hint: None, None
            size: 275, 250
            pos_hint: {'middle': 1, 'center': 1}
            on_parent:
                if self.parent == settings_tab: self.parent.remove_widget(self)

            BoxLayout:
                orientation: 'vertical'

                Label:
                    text: 'Entering Modify Main Screen will turn off all outputs.  Proceed?'
                    size_hint: 1, .7
                    height: self.texture_size[1]
                    font_size: '18sp'
                    text_size: self.size
                    halign: 'center'
                    valign: 'middle'

                GridLayout:
                    rows: 1
                    cols: 2
                    size_hint: 1, .3

                    Button:
                        text: 'Yes'
                        on_release: enter_modify_popup.dismiss(); dynamic_layout.modify_screen(); main_tabbed_panel.switch_to(home_tab); root.add_widget(end_modify_button)

                    Button:
                        text: 'Cancel'
                        on_release: enter_modify_popup.dismiss(); app.arduino.toggle_ser_read(True)


<MainButton@Button>:
    font_size: '20sp'

<PumpState@LabelB>:
    font_size: '18sp'
    markup: 'True'
    #bcolor_on: 0.19, 0.64, 0.8, 1
    bcolor_on: 0.03, 0.55, 0.07, 1
    bcolor_off: 0.34, 0.34, 0.34, 1
